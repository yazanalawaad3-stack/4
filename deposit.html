<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deposit</title>
  <!-- Keep your existing CSS links unchanged in your project -->
  <style>
    /* This file keeps layout minimal; your original project CSS should style it.
       If you already have a styled deposit.html, you can copy only the <script> part below. */
  </style>
</head>
<body>

  <!-- Your original deposit page markup should remain here.
       If you replace your existing file, keep your original HTML structure and only replace the script logic below.
       This version assumes your page has:
         - Network buttons with class "network-button" and text: BEP20/TRC20/ERC20
         - Address container with class "address-text" (or id="depositAddress")
         - QR image element with id="qrImg"
         - Caption element with class "qr-caption" (optional)
  -->

  <!-- Load your existing JS stack -->
  <script src="sb-config.js"></script>
  <script src="auth.js"></script>
  <script src="common-nav.js"></script>
  <script src="sb-user.js"></script>
  <script src="wallet.js"></script>

  <script>
  (function () {
    // ---- CONFIG ----
    var EDGE_FUNCTION = "nowpayments-create-payment";
    var DEFAULT_AMOUNT_USD = 100; // change if you want (must be > 0)

    // ---- DOM HELPERS (non-breaking: tries multiple selectors) ----
    function $(sel){ return document.querySelector(sel); }
    function pickAddressEl(){
      return $(".address-text") || $("#depositAddress") || $("#deposit_address") || null;
    }
    function pickQrImgEl(){
      return $("#qrImg") || $(".qr img") || $("img.qr") || null;
    }
    function pickCaptionEl(){
      return $(".qr-caption") || $("#qrCaption") || null;
    }

    var addressTextEl = pickAddressEl();
    var qrImgEl = pickQrImgEl();
    var qrCaptionEl = pickCaptionEl();

    function setText(el, txt){ if(el) el.textContent = txt; }
    function setQr(addr){
      if(!qrImgEl) return;
      if(!addr){ qrImgEl.removeAttribute("src"); return; }
      // QR as an image (no external libs)
      var qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=" + encodeURIComponent(addr);
      qrImgEl.src = qrUrl;
      qrImgEl.alt = "QR";
    }

    function getCurrentSupabaseUserId() {
      try {
        if (window.ExaAuth && typeof window.ExaAuth.ensureSupabaseUserId === "function") {
          return window.ExaAuth.ensureSupabaseUserId().then(function (id) {
            return id ? String(id) : "";
          });
        }
      } catch (e) {}
      return Promise.resolve("");
    }

    function buildFnUrl() {
      // SB_CONFIG should expose projectUrl + anonKey (your sb-config.js already does this)
      var url = (window.SB_CONFIG && window.SB_CONFIG.projectUrl) ? window.SB_CONFIG.projectUrl : "";
      if (!url) return "";
      return url.replace(/\/+$/, "") + "/functions/v1/" + EDGE_FUNCTION;
    }

    async function fetchBep20Address() {
      var userId = await getCurrentSupabaseUserId();
      if (!userId) throw new Error("No user id (not logged in)");

      var fnUrl = buildFnUrl();
      if (!fnUrl) throw new Error("Missing projectUrl in SB_CONFIG");

      var anonKey = (window.SB_CONFIG && window.SB_CONFIG.anonKey) ? window.SB_CONFIG.anonKey : "";
      if (!anonKey) throw new Error("Missing anonKey in SB_CONFIG");

      var res = await fetch(fnUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": anonKey,
          "Authorization": "Bearer " + anonKey
        },
        body: JSON.stringify({
          user_id: userId,
          amount_usd: DEFAULT_AMOUNT_USD
        })
      });

      var data = await res.json().catch(function(){ return null; });
      if (!res.ok) {
        throw new Error((data && (data.error || data.details)) ? (data.error || data.details) : ("HTTP " + res.status));
      }
      var addr = (data && data.pay_address) ? String(data.pay_address) : "";
      if (!addr) throw new Error("No pay_address returned");
      return addr;
    }

    async function refresh() {
      setText(addressTextEl, "Loading...");
      setQr("");
      setText(qrCaptionEl, "Fetching BEP20 USDT address...");
      try {
        // You said only BEP20 is active now
        var addr = await fetchBep20Address();
        setText(addressTextEl, addr);
        setQr(addr);
        setText(qrCaptionEl, "This address only supports deposits of BEP20 USDT");
      } catch (e) {
        console.error(e);
        setText(addressTextEl, "Error");
        setText(qrCaptionEl, String(e && e.message ? e.message : e));
      }
    }

    // Disable other networks visually (no style changes, just prevents action)
    function wireNetworkButtons() {
      var btns = document.querySelectorAll(".network-button, .network-btn, .network-item");
      btns.forEach(function(btn){
        var t = (btn.textContent || "").trim().toUpperCase();
        btn.addEventListener("click", function(){
          if (t !== "BEP20") {
            // keep UI, but do nothing
            setText(qrCaptionEl, "Only BEP20 is enabled right now");
            return;
          }
          refresh();
        });
      });
    }

    wireNetworkButtons();

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", refresh);
    } else {
      refresh();
    }
  })();
  </script>
</body>
</html>
