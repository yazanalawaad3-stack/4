<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deposit</title>
  <!-- Keep your existing CSS/markup: this file only replaces the JS logic safely. -->
</head>
<body>
  <!-- IMPORTANT:
       Copy/paste ONLY the script block below into your existing deposit.html (before </body>),
       or replace your deposit.html with your own design + this script.
  -->
  <script src="sb-config.js"></script>
  <script src="sb-user.js"></script>
  <script src="auth.js"></script>

  <script>
  (function () {
    // ====== CONFIG ======
    const FUNCTION_NAME = "nowpayments-create-payment"; // existing Edge Function
    const DEFAULT_AMOUNT_USD = 100; // change if you want a different default
    const PAY_CURRENCY = "usdtbsc"; // BEP20 USDT for NOWPayments

    // ====== HELPERS ======
    function qs(sel){ return document.querySelector(sel); }
    function setText(el, txt){ if(el) el.textContent = txt; }
    function setValue(el, val){ if(el) el.value = val; }
    function showError(msg){
      console.error(msg);
      const addrBox = qs("#depositAddress") || qs("[data-deposit-address]");
      if (addrBox) setText(addrBox, msg);
    }

    // ====== UI HOOKS (support your existing DOM) ======
    // Tries a few common ids/classes used in your page.
    const elAddress = qs("#depositAddress") || qs(".deposit-address") || qs("[data-deposit-address]");
    const elQrImg   = qs("#depositQr") || qs("#qrImage") || qs("img[data-deposit-qr]") || qs(".qr img");
    const elStatus  = qs("#depositStatus") || qs(".deposit-status") || qs("[data-deposit-status]");

    async function getSessionToken(){
      try {
        if (window.sbUser?.getSession) {
          const s = await window.sbUser.getSession();
          return s?.access_token || null;
        }
      } catch(e) {}
      // fallback: raw localStorage used by your auth.js
      const raw = localStorage.getItem("sb_access_token");
      return raw || null;
    }

    async function getUserId(){
      try {
        if (window.ExaAuth?.ensureSupabaseUserId) {
          return await window.ExaAuth.ensureSupabaseUserId();
        }
      } catch(e) {}
      return localStorage.getItem("supabase_user_id");
    }

    function makeQrUrl(text){
      // No external libs needed. Uses a free QR image endpoint.
      // If you already have a local qr generator, replace this.
      return "https://api.qrserver.com/v1/create-qr-code/?size=260x260&data=" + encodeURIComponent(text);
    }

    async function fetchDepositAddress(){
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showError("Supabase config missing");
        return;
      }

      const user_id = await getUserId();
      if (!user_id) {
        showError("Please login first");
        return;
      }

      setText(elStatus, "Fetching BEP20 USDT address...");
      setText(elAddress, "Loading...");

      const url = window.SUPABASE_URL.replace(/\/$/, "") + "/functions/v1/" + FUNCTION_NAME;

      const token = await getSessionToken(); // may be null; function uses service role internally
      const headers = {
        "Content-Type": "application/json",
        "apikey": window.SUPABASE_ANON_KEY
      };
      if (token) headers["Authorization"] = "Bearer " + token;

      const body = {
        user_id,
        amount_usd: DEFAULT_AMOUNT_USD,
        pay_currency: PAY_CURRENCY
      };

      try {
        const res = await fetch(url, { method: "POST", headers, body: JSON.stringify(body) });
        const json = await res.json().catch(() => ({}));
        if (!res.ok) {
          showError("Create payment failed: " + (json?.error || res.status));
          return;
        }

        const addr = json?.pay_address || json?.address || "";
        if (!addr) {
          showError("No address returned");
          return;
        }

        setText(elStatus, "This address only supports deposits of BEP20 USDT");
        setText(elAddress, addr);

        if (elQrImg) elQrImg.src = makeQrUrl(addr);
      } catch (e) {
        showError("Network error: " + (e && e.message ? e.message : String(e)));
      }
    }

    document.addEventListener("DOMContentLoaded", fetchDepositAddress);
  })();
  </script>
</body>
</html>
